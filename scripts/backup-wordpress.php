<?php
/**
 * SAUVEGARDE WORDPRESS COMPL√àTE - Script Expert
 * 
 * Script de sauvegarde automatis√©e compl√®te pour WordPress
 * Fichiers + Base de donn√©es + Configuration + Validation
 * 
 * Bas√© sur 12+ ann√©es d'exp√©rience - 1000+ sauvegardes cr√©√©es
 * Sauvegarde fiable et test√©e en restauration
 * 
 * @author Teddy - Expert WordPress
 * @version 3.0
 * @website https://teddywp.com
 * @service https://teddywp.com/depannage-wordpress/
 * 
 * Usage: php backup-wordpress.php [chemin-wordpress] [--compress] [--exclude-uploads] [--test-restore]
 */

// Configuration robuste
error_reporting(E_ALL);
ini_set('display_errors', 1);
ini_set('max_execution_time', 3600); // 1 heure max
ini_set('memory_limit', '1024M');

class WordPressBackupManager {
    
    private $wordpress_path;
    private $backup_directory;
    private $compress_backup;
    private $exclude_uploads;
    private $test_restore;
    private $start_time;
    private $backup_stats = array();
    
    // Configuration de sauvegarde bas√©e sur l'exp√©rience
    private $backup_config = array(
        'excluded_dirs' => array(
            'wp-content/cache',
            'wp-content/backup',
            'wp-content/backups',
            'wp-content/ai1wm-backups',
            'wp-content/updraft'
        ),
        'excluded_files' => array(
            '.htaccess.bak',
            'wp-config-backup.php',
            'error_log',
            'debug.log',
            '.DS_Store',
            'Thumbs.db'
        ),
        'critical_files' => array(
            'wp-config.php',
            '.htaccess',
            'index.php',
            'wp-load.php'
        ),
        'max_file_size' => 100 * 1024 * 1024, // 100MB max par fichier
        'chunk_size' => 1024 * 1024 // 1MB chunks pour gros fichiers
    );
    
    public function __construct($wordpress_path = './', $options = array()) {
        $this->wordpress_path = rtrim($wordpress_path, '/') . '/';
        $this->compress_backup = isset($options['compress']) ? $options['compress'] : false;
        $this->exclude_uploads = isset($options['exclude_uploads']) ? $options['exclude_uploads'] : false;
        $this->test_restore = isset($options['test_restore']) ? $options['test_restore'] : false;
        $this->start_time = microtime(true);
        
        echo "üíæ SAUVEGARDE WORDPRESS COMPL√àTE - EXPERT\n";
        echo "=========================================\n";
        echo "üë®‚Äçüíª D√©velopp√© par Teddy - Expert WordPress\n";
        echo "üìä Bas√© sur 1000+ sauvegardes cr√©√©es et test√©es\n";
        echo "üõ°Ô∏è  Sauvegarde fiable avec validation int√©gr√©e\n\n";
        
        if ($this->compress_backup) {
            echo "üóúÔ∏è  COMPRESSION ACTIV√âE\n";
        }
        
        if ($this->exclude_uploads) {
            echo "üìÅ EXCLUSION UPLOADS ACTIV√âE\n";
        }
        
        if ($this->test_restore) {
            echo "üß™ TEST DE RESTAURATION ACTIV√â\n";
        }
        
        echo "üìç Site WordPress: {$this->wordpress_path}\n\n";
        
        if (!is_dir($this->wordpress_path)) {
            die("‚ùå Erreur: Chemin WordPress introuvable: {$this->wordpress_path}\n");
        }
        
        $this->initializeBackupStats();
        $this->setupBackupDirectory();
    }
    
    /**
     * Sauvegarde compl√®te WordPress
     */
    public function runCompleteBackup() {
        echo "üöÄ D√âMARRAGE SAUVEGARDE COMPL√àTE\n";
        echo "================================\n\n";
        
        $this->checkSystemRequirements();
        $this->analyzeWordPressSite();
        $this->backupDatabase();
        $this->backupFiles();
        $this->createBackupManifest();
        $this->validateBackup();
        
        if ($this->test_restore) {
            $this->testBackupRestore();
        }
        
        $this->generateBackupReport();
    }
    
    /**
     * Initialisation des statistiques
     */
    private function initializeBackupStats() {
        $this->backup_stats = array(
            'files_backed_up' => 0,
            'files_skipped' => 0,
            'total_size' => 0,
            'backup_size' => 0,
            'database_size' => 0,
            'compression_ratio' => 0,
            'backup_duration' => 0,
            'errors' => 0,
            'warnings' => 0
        );
    }
    
    /**
     * Configuration du dossier de sauvegarde
     */
    private function setupBackupDirectory() {
        echo "üìÅ 1. CONFIGURATION DOSSIER SAUVEGARDE\n";
        echo "--------------------------------------\n";
        
        // Cr√©ation du nom de sauvegarde unique
        $timestamp = date('Y-m-d_H-i-s');
        $site_name = $this->getSiteName();
        $backup_name = "wordpress-backup_{$site_name}_{$timestamp}";
        
        // Dossier de sauvegarde principal
        $this->backup_directory = $this->wordpress_path . 'backups/' . $backup_name . '/';
        
        // Cr√©ation des dossiers
        if (!is_dir(dirname($this->backup_directory))) {
            mkdir(dirname($this->backup_directory), 0755, true);
        }
        
        if (!mkdir($this->backup_directory, 0755, true)) {
            die("‚ùå Erreur: Impossible de cr√©er le dossier de sauvegarde\n");
        }
        
        // Sous-dossiers
        $subdirs = array('database', 'files', 'config', 'logs');
        foreach ($subdirs as $subdir) {
            mkdir($this->backup_directory . $subdir, 0755, true);
        }
        
        echo "‚úÖ Dossier cr√©√©: backups/$backup_name/\n";
        echo "üìÇ Structure: database/, files/, config/, logs/\n";
        
        // Protection par .htaccess
        $htaccess_content = "Order deny,allow\nDeny from all\n";
        file_put_contents(dirname($this->backup_directory) . '/.htaccess', $htaccess_content);
        
        echo "üîí Protection .htaccess cr√©√©e\n\n";
    }
    
    /**
     * V√©rification des pr√©requis syst√®me
     */
    private function checkSystemRequirements() {
        echo "üîß 2. V√âRIFICATION PR√âREQUIS\n";
        echo "---------------------------\n";
        
        // V√©rification espace disque
        $free_space = disk_free_space($this->wordpress_path);
        $total_size = $this->calculateSiteSize();
        
        echo "üíæ Espace libre: " . $this->formatBytes($free_space) . "\n";
        echo "üìä Taille site: " . $this->formatBytes($total_size) . "\n";
        
        if ($free_space < ($total_size * 1.5)) {
            echo "‚ö†Ô∏è  ATTENTION: Espace disque limit√©\n";
            echo "üí° Recommandation: Lib√©rez de l'espace ou utilisez --exclude-uploads\n";
            $this->backup_stats['warnings']++;
        } else {
            echo "‚úÖ Espace disque suffisant\n";
        }
        
        // V√©rification permissions
        $writable_dirs = array(
            $this->wordpress_path,
            dirname($this->backup_directory)
        );
        
        foreach ($writable_dirs as $dir) {
            if (!is_writable($dir)) {
                die("‚ùå Erreur: Permissions insuffisantes sur $dir\n");
            }
        }
        
        echo "‚úÖ Permissions d'√©criture OK\n";
        
        // V√©rification outils de compression
        if ($this->compress_backup) {
            if (class_exists('ZipArchive')) {
                echo "‚úÖ ZipArchive disponible\n";
            } elseif (function_exists('gzopen')) {
                echo "‚úÖ GZip disponible\n";
            } else {
                echo "‚ö†Ô∏è  Aucun outil de compression - d√©sactivation automatique\n";
                $this->compress_backup = false;
                $this->backup_stats['warnings']++;
            }
        }
        
        echo "\n";
    }
    
    /**
     * Analyse du site WordPress
     */
    private function analyzeWordPressSite() {
        echo "üîç 3. ANALYSE SITE WORDPRESS\n";
        echo "---------------------------\n";
        
        // V√©rification fichiers WordPress critiques
        $missing_files = array();
        foreach ($this->backup_config['critical_files'] as $file) {
            $file_path = $this->wordpress_path . $file;
            if (file_exists($file_path)) {
                echo "‚úÖ $file\n";
            } else {
                echo "‚ùå $file (MANQUANT)\n";
                $missing_files[] = $file;
                $this->backup_stats['errors']++;
            }
        }
        
        if (!empty($missing_files)) {
            echo "‚ö†Ô∏è  Fichiers critiques manquants d√©tect√©s\n";
        }
        
        // D√©tection de la version WordPress
        $wp_version = $this->getWordPressVersion();
        if ($wp_version) {
            echo "üìä Version WordPress: $wp_version\n";
        }
        
        // Analyse des plugins et th√®mes
        $plugins_count = $this->countPlugins();
        $themes_count = $this->countThemes();
        
        echo "üîå Plugins install√©s: $plugins_count\n";
        echo "üé® Th√®mes install√©s: $themes_count\n";
        
        // Taille des dossiers principaux
        $sizes = array(
            'wp-content/uploads' => $this->calculateDirectorySize($this->wordpress_path . 'wp-content/uploads'),
            'wp-content/plugins' => $this->calculateDirectorySize($this->wordpress_path . 'wp-content/plugins'),
            'wp-content/themes' => $this->calculateDirectorySize($this->wordpress_path . 'wp-content/themes')
        );
        
        foreach ($sizes as $dir => $size) {
            if ($size > 0) {
                echo "üìÅ $dir: " . $this->formatBytes($size) . "\n";
            }
        }
        
        echo "\n";
    }
    
    /**
     * Sauvegarde de la base de donn√©es
     */
    private function backupDatabase() {
        echo "üóÑÔ∏è  4. SAUVEGARDE BASE DE DONN√âES\n";
        echo "--------------------------------\n";
        
        $wp_config_path = $this->wordpress_path . 'wp-config.php';
        
        if (!file_exists($wp_config_path)) {
            echo "‚ùå wp-config.php introuvable - saut de la DB\n\n";
            $this->backup_stats['errors']++;
            return;
        }
        
        // Extraction des param√®tres DB
        $db_config = $this->extractDatabaseConfig($wp_config_path);
        
        if (!$db_config) {
            echo "‚ùå Configuration DB non trouv√©e\n\n";
            $this->backup_stats['errors']++;
            return;
        }
        
        echo "‚úÖ Configuration DB charg√©e\n";
        echo "üè† Host: {$db_config['DB_HOST']}\n";
        echo "üóÑÔ∏è  Base: {$db_config['DB_NAME']}\n";
        
        // Test de connexion
        if (!$this->testDatabaseConnection($db_config)) {
            echo "‚ùå Connexion DB √©chou√©e\n\n";
            $this->backup_stats['errors']++;
            return;
        }
        
        echo "‚úÖ Connexion DB r√©ussie\n";
        
        // Cr√©ation du dump SQL
        $sql_file = $this->backup_directory . 'database/database.sql';
        $dump_success = $this->createDatabaseDump($db_config, $sql_file);
        
        if ($dump_success) {
            $db_size = filesize($sql_file);
            $this->backup_stats['database_size'] = $db_size;
            
            echo "‚úÖ Dump SQL cr√©√©: " . $this->formatBytes($db_size) . "\n";
            
            // Compression du dump si demand√©e
            if ($this->compress_backup) {
                $compressed_file = $this->compressFile($sql_file);
                if ($compressed_file) {
                    $compressed_size = filesize($compressed_file);
                    $compression_ratio = round((($db_size - $compressed_size) / $db_size) * 100, 1);
                    echo "üóúÔ∏è  Dump compress√©: " . $this->formatBytes($compressed_size) . " ($compression_ratio% √©conomis√©)\n";
                    unlink($sql_file); // Suppression version non compress√©e
                }
            }
            
        } else {
            echo "‚ùå √âchec cr√©ation dump SQL\n";
            $this->backup_stats['errors']++;
        }
        
        echo "\n";
    }
    
    /**
     * Sauvegarde des fichiers
     */
    private function backupFiles() {
        echo "üìÅ 5. SAUVEGARDE FICHIERS WORDPRESS\n";
        echo "----------------------------------\n";
        
        $files_to_backup = $this->scanFilesForBackup();
        $total_files = count($files_to_backup);
        
        echo "üìä Fichiers √† sauvegarder: $total_files\n";
        
        if (empty($files_to_backup)) {
            echo "‚ö†Ô∏è  Aucun fichier √† sauvegarder\n\n";
            return;
        }
        
        $progress = 0;
        $backup_errors = 0;
        
        foreach ($files_to_backup as $source_file) {
            $progress++;
            $relative_path = str_replace($this->wordpress_path, '', $source_file);
            
            // Affichage du progr√®s
            if ($progress % 100 == 0 || $progress == $total_files) {
                echo "\rüîÑ Progression: $progress/$total_files fichiers";
            }
            
            try {
                // Destination de sauvegarde
                $backup_file = $this->backup_directory . 'files/' . $relative_path;
                $backup_dir = dirname($backup_file);
                
                // Cr√©ation du dossier si n√©cessaire
                if (!is_dir($backup_dir)) {
                    mkdir($backup_dir, 0755, true);
                }
                
                // Copie du fichier
                if ($this->copyFileSecurely($source_file, $backup_file)) {
                    $this->backup_stats['files_backed_up']++;
                    $this->backup_stats['backup_size'] += filesize($backup_file);
                } else {
                    $backup_errors++;
                    $this->backup_stats['errors']++;
                }
                
            } catch (Exception $e) {
                $backup_errors++;
                $this->backup_stats['errors']++;
            }
        }
        
        echo "\n\n‚úÖ Sauvegarde fichiers termin√©e\n";
        echo "üìä Fichiers sauvegard√©s: {$this->backup_stats['files_backed_up']}\n";
        echo "üìä Erreurs: $backup_errors\n";
        echo "üíæ Taille sauvegarde: " . $this->formatBytes($this->backup_stats['backup_size']) . "\n";
        
        echo "\n";
    }
    
    /**
     * Cr√©ation du manifeste de sauvegarde
     */
    private function createBackupManifest() {
        echo "üìã 6. CR√âATION MANIFESTE SAUVEGARDE\n";
        echo "----------------------------------\n";
        
        $manifest = array(
            'backup_info' => array(
                'created_at' => date('Y-m-d H:i:s'),
                'wordpress_path' => $this->wordpress_path,
                'site_name' => $this->getSiteName(),
                'wordpress_version' => $this->getWordPressVersion(),
                'php_version' => phpversion(),
                'backup_script_version' => '3.0'
            ),
            'backup_stats' => $this->backup_stats,
            'backup_config' => array(
                'compress_backup' => $this->compress_backup,
                'exclude_uploads' => $this->exclude_uploads,
                'excluded_dirs' => $this->backup_config['excluded_dirs'],
                'excluded_files' => $this->backup_config['excluded_files']
            ),
            'database_info' => array(
                'included' => file_exists($this->backup_directory . 'database/database.sql') || 
                             file_exists($this->backup_directory . 'database/database.sql.gz'),
                'size' => $this->backup_stats['database_size']
            ),
            'files_info' => array(
                'total_files' => $this->backup_stats['files_backed_up'],
                'total_size' => $this->backup_stats['backup_size']
            ),
            'restoration_notes' => array(
                'wp_config_path' => 'config/wp-config.php',
                'htaccess_path' => 'config/.htaccess',
                'database_dump' => 'database/database.sql',
                'files_root' => 'files/'
            )
        );
        
        // Sauvegarde des fichiers de configuration critiques
        $config_files = array('wp-config.php', '.htaccess');
        foreach ($config_files as $config_file) {
            $source = $this->wordpress_path . $config_file;
            $dest = $this->backup_directory . 'config/' . $config_file;
            
            if (file_exists($source)) {
                copy($source, $dest);
                echo "‚úÖ Configuration sauvegard√©e: $config_file\n";
            }
        }
        
        // √âcriture du manifeste
        $manifest_file = $this->backup_directory . 'backup-manifest.json';
        if (file_put_contents($manifest_file, json_encode($manifest, JSON_PRETTY_PRINT))) {
            echo "‚úÖ Manifeste cr√©√©: backup-manifest.json\n";
        } else {
            echo "‚ùå Erreur cr√©ation manifeste\n";
            $this->backup_stats['errors']++;
        }
        
        // Cr√©ation du fichier README
        $this->createBackupReadme();
        
        echo "\n";
    }
    
    /**
     * Validation de la sauvegarde
     */
    private function validateBackup() {
        echo "üîç 7. VALIDATION SAUVEGARDE\n";
        echo "--------------------------\n";
        
        $validation_errors = 0;
        
        // V√©rification structure des dossiers
        $required_dirs = array('database', 'files', 'config');
        foreach ($required_dirs as $dir) {
            $dir_path = $this->backup_directory . $dir;
            if (is_dir($dir_path)) {
                echo "‚úÖ Dossier $dir pr√©sent\n";
            } else {
                echo "‚ùå Dossier $dir manquant\n";
                $validation_errors++;
            }
        }
        
        // V√©rification base de donn√©es
        $db_files = glob($this->backup_directory . 'database/*');
        if (!empty($db_files)) {
            $db_file = $db_files[0];
            $db_size = filesize($db_file);
            
            if ($db_size > 1000) { // Minimum 1KB
                echo "‚úÖ Dump base de donn√©es valide (" . $this->formatBytes($db_size) . ")\n";
                
                // V√©rification rapide du contenu SQL
                $db_content = file_get_contents($db_file, false, null, 0, 1000);
                if (strpos($db_content, 'CREATE TABLE') !== false || strpos($db_content, 'INSERT INTO') !== false) {
                    echo "‚úÖ Contenu SQL valid√©\n";
                } else {
                    echo "‚ö†Ô∏è  Contenu SQL suspect\n";
                    $validation_errors++;
                }
            } else {
                echo "‚ùå Dump base de donn√©es trop petit\n";
                $validation_errors++;
            }
        } else {
            echo "‚ùå Aucun dump base de donn√©es trouv√©\n";
            $validation_errors++;
        }
        
        // V√©rification fichiers critiques
        $critical_backups = array(
            'files/wp-config.php',
            'files/index.php',
            'config/wp-config.php'
        );
        
        foreach ($critical_backups as $critical_file) {
            $file_path = $this->backup_directory . $critical_file;
            if (file_exists($file_path)) {
                echo "‚úÖ Fichier critique sauvegard√©: " . basename($critical_file) . "\n";
            } else {
                echo "‚ö†Ô∏è  Fichier critique manquant: " . basename($critical_file) . "\n";
                $validation_errors++;
            }
        }
        
        // V√©rification manifeste
        $manifest_file = $this->backup_directory . 'backup-manifest.json';
        if (file_exists($manifest_file)) {
            $manifest = json_decode(file_get_contents($manifest_file), true);
            if ($manifest && isset($manifest['backup_info'])) {
                echo "‚úÖ Manifeste de sauvegarde valide\n";
            } else {
                echo "‚ùå Manifeste de sauvegarde corrompu\n";
                $validation_errors++;
            }
        } else {
            echo "‚ùå Manifeste de sauvegarde manquant\n";
            $validation_errors++;
        }
        
        // R√©sultat de la validation
        if ($validation_errors == 0) {
            echo "\nüéâ VALIDATION R√âUSSIE - Sauvegarde compl√®te et valide\n";
        } else {
            echo "\n‚ö†Ô∏è  VALIDATION PARTIELLE - $validation_errors erreur(s) d√©tect√©e(s)\n";
            $this->backup_stats['warnings'] += $validation_errors;
        }
        
        echo "\n";
    }
    
    /**
     * Test de restauration (optionnel)
     */
    private function testBackupRestore() {
        echo "üß™ 8. TEST DE RESTAURATION\n";
        echo "-------------------------\n";
        
        echo "üîÑ Cr√©ation environnement de test...\n";
        
        $test_dir = $this->backup_directory . 'restore-test/';
        if (!mkdir($test_dir, 0755, true)) {
            echo "‚ùå Impossible de cr√©er l'environnement de test\n\n";
            return;
        }
        
        // Test de restauration des fichiers critiques
        $test_files = array(
            'wp-config.php' => 'config/wp-config.php',
            'index.php' => 'files/index.php'
        );
        
        $restore_success = true;
        
        foreach ($test_files as $target => $source) {
            $source_path = $this->backup_directory . $source;
            $target_path = $test_dir . $target;
            
            if (file_exists($source_path)) {
                if (copy($source_path, $target_path)) {
                    echo "‚úÖ Test restauration: $target\n";
                } else {
                    echo "‚ùå √âchec restauration: $target\n";
                    $restore_success = false;
                }
            }
        }
        
        // Test de validation du dump SQL
        $db_files = glob($this->backup_directory . 'database/*');
        if (!empty($db_files)) {
            $db_file = $db_files[0];
            
            // V√©rification syntaxe SQL basique
            $sql_sample = file_get_contents($db_file, false, null, 0, 10000);
            
            if (strpos($sql_sample, 'CREATE TABLE') !== false && strpos($sql_sample, ';') !== false) {
                echo "‚úÖ Test syntaxe SQL: Valide\n";
            } else {
                echo "‚ùå Test syntaxe SQL: Invalide\n";
                $restore_success = false;
            }
        }
        
        // Nettoyage du test
        $this->removeDirectory($test_dir);
        
        if ($restore_success) {
            echo "üéâ TEST DE RESTAURATION R√âUSSI\n";
        } else {
            echo "‚ö†Ô∏è  TEST DE RESTAURATION PARTIEL\n";
            $this->backup_stats['warnings']++;
        }
        
        echo "\n";
    }
    
    /**
     * G√©n√©ration du rapport final
     */
    private function generateBackupReport() {
        $end_time = microtime(true);
        $total_time = round($end_time - $this->start_time, 2);
        $this->backup_stats['backup_duration'] = $total_time;
        
        echo "üìã RAPPORT SAUVEGARDE WORDPRESS\n";
        echo "===============================\n\n";
        
        // Informations g√©n√©rales
        echo "üìä R√âSUM√â SAUVEGARDE:\n";
        echo "====================\n";
        echo "‚è±Ô∏è  Dur√©e totale: {$total_time} secondes\n";
        echo "üìÅ Fichiers sauvegard√©s: {$this->backup_stats['files_backed_up']}\n";
        echo "üóÑÔ∏è  Base de donn√©es: " . ($this->backup_stats['database_size'] > 0 ? 'Incluse' : 'Exclue') . "\n";
        echo "üíæ Taille totale: " . $this->formatBytes($this->backup_stats['backup_size'] + $this->backup_stats['database_size']) . "\n";
        echo "‚ùå Erreurs: {$this->backup_stats['errors']}\n";
        echo "‚ö†Ô∏è  Avertissements: {$this->backup_stats['warnings']}\n\n";
        
        // D√©tail des composants
        echo "üîç D√âTAIL COMPOSANTS:\n";
        echo "====================\n";
        echo "üìÑ Fichiers WordPress: " . $this->formatBytes($this->backup_stats['backup_size']) . "\n";
        echo "üóÑÔ∏è  Base de donn√©es: " . $this->formatBytes($this->backup_stats['database_size']) . "\n";
        echo "‚öôÔ∏è  Fichiers config: Inclus\n";
        echo "üìã Manifeste: Inclus\n";
        echo "üìñ Documentation: Incluse\n\n";
        
        // Emplacement de la sauvegarde
        $backup_name = basename($this->backup_directory);
        echo "üìç EMPLACEMENT SAUVEGARDE:\n";
        echo "=========================\n";
        echo "üìÅ Dossier: backups/$backup_name/\n";
        echo "üîó Chemin complet: {$this->backup_directory}\n\n";
        
        // √âvaluation de la sauvegarde
        if ($this->backup_stats['errors'] == 0 && $this->backup_stats['warnings'] <= 2) {
            $backup_quality = "üåü EXCELLENTE";
            $reliability = "Sauvegarde compl√®te et fiable";
        } elseif ($this->backup_stats['errors'] <= 2 && $this->backup_stats['warnings'] <= 5) {
            $backup_quality = "‚úÖ BONNE";
            $reliability = "Sauvegarde fonctionnelle avec avertissements mineurs";
        } elseif ($this->backup_stats['errors'] <= 5) {
            $backup_quality = "‚ö†Ô∏è  PARTIELLE";
            $reliability = "Sauvegarde incompl√®te - v√©rification recommand√©e";
        } else {
            $backup_quality = "‚ùå PROBL√âMATIQUE";
            $reliability = "Sauvegarde avec erreurs importantes";
        }
        
        echo "üéØ QUALIT√â SAUVEGARDE: $backup_quality\n";
        echo "üõ°Ô∏è  FIABILIT√â: $reliability\n\n";
        
        // Instructions de restauration
        echo "üîÑ INSTRUCTIONS RESTAURATION:\n";
        echo "============================\n";
        echo "1. üìÅ Copiez le contenu de files/ vers votre nouveau WordPress\n";
        echo "2. üóÑÔ∏è  Importez database/database.sql dans votre base MySQL\n";
        echo "3. ‚öôÔ∏è  Copiez config/wp-config.php et adaptez les param√®tres DB\n";
        echo "4. üîó Copiez config/.htaccess si n√©cessaire\n";
        echo "5. üîê V√©rifiez les permissions des fichiers et dossiers\n";
        echo "6. üß™ Testez votre site restaur√©\n\n";
        
        // Conseils de maintenance
        echo "üí° CONSEILS MAINTENANCE SAUVEGARDE:\n";
        echo "===================================\n";
        echo "‚Ä¢ üìÖ Sauvegarde automatique: Hebdomadaire minimum\n";
        echo "‚Ä¢ üîÑ Test de restauration: Mensuel\n";
        echo "‚Ä¢ üíæ Conservation: 3 sauvegardes minimum\n";
        echo "‚Ä¢ üåê Stockage externe: Recommand√© (cloud, serveur distant)\n";
        echo "‚Ä¢ üîí Chiffrement: Pour donn√©es sensibles\n";
        echo "‚Ä¢ üìä Monitoring: Surveiller la taille des sauvegardes\n\n";
        
        // Commandes utiles
        echo "üõ†Ô∏è  COMMANDES UTILES:\n";
        echo "===================\n";
        echo "# Compression manuelle de la sauvegarde:\n";
        echo "tar -czf $backup_name.tar.gz $backup_name/\n\n";
        echo "# V√©rification int√©grit√©:\n";
        echo "find $backup_name/ -type f -exec md5sum {} \\;\n\n";
        echo "# Restauration base de donn√©es:\n";
        echo "mysql -u username -p database_name < database/database.sql\n\n";
        
        // Performance de la sauvegarde
        $files_per_second = round($this->backup_stats['files_backed_up'] / max($total_time, 1), 1);
        $mb_per_second = round(($this->backup_stats['backup_size'] / 1024 / 1024) / max($total_time, 1), 2);
        
        echo "‚ö° PERFORMANCE SAUVEGARDE:\n";
        echo "=========================\n";
        echo "üìÑ Fichiers/seconde: $files_per_second\n";
        echo "üíæ MB/seconde: $mb_per_second\n";
        echo "üéØ Efficacit√©: " . ($files_per_second > 10 ? "Excellente" : ($files_per_second > 5 ? "Bonne" : "Lente")) . "\n\n";
        
        // Contact expert pour gros sites
        if ($this->backup_stats['files_backed_up'] > 10000 || ($this->backup_stats['backup_size'] + $this->backup_stats['database_size']) > 1024*1024*1024) {
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            echo "üè¢ SITE VOLUMINEUX D√âTECT√â\n";
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            echo "üîß Solution sauvegarde professionnelle recommand√©e\n";
            echo "‚òÅÔ∏è  Configuration sauvegarde cloud automatis√©e\n";
            echo "üèÜ 1000+ sauvegardes WordPress g√©r√©es avec succ√®s\n";
            echo "üìû Service professionnel: https://teddywp.com/depannage-wordpress/\n";
            echo "üí° Consultation gratuite sauvegarde entreprise\n";
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        }
        
        echo "\nüë®‚Äçüíª Sauvegarde r√©alis√©e par Teddy - Expert WordPress\n";
        echo "üåê TeddyWP.com | üìß Solution sauvegarde professionnelle 24/7\n";
        echo "üìÖ " . date('Y-m-d H:i:s') . " | Version script: 3.0\n";
    }
    
    /**
     * M√©thodes utilitaires
     */
    
    private function getSiteName() {
        // Extraction du nom de domaine ou dossier
        $path = rtrim($this->wordpress_path, '/');
        $name = basename($path);
        
        // Nettoyage pour nom de fichier valide
        $name = preg_replace('/[^a-zA-Z0-9_-]/', '_', $name);
        return substr($name, 0, 20);
    }
    
    private function getWordPressVersion() {
        $version_file = $this->wordpress_path . 'wp-includes/version.php';
        if (file_exists($version_file)) {
            $version_content = file_get_contents($version_file);
            if (preg_match('/\$wp_version\s*=\s*[\'"]([^\'"]+)[\'"]/i', $version_content, $matches)) {
                return $matches[1];
            }
        }
        return 'Inconnue';
    }
    
    private function countPlugins() {
        $plugins_dir = $this->wordpress_path . 'wp-content/plugins/';
        if (is_dir($plugins_dir)) {
            $plugins = glob($plugins_dir . '*', GLOB_ONLYDIR);
            return count($plugins);
        }
        return 0;
    }
    
    private function countThemes() {
        $themes_dir = $this->wordpress_path . 'wp-content/themes/';
        if (is_dir($themes_dir)) {
            $themes = glob($themes_dir . '*', GLOB_ONLYDIR);
            return count($themes);
        }
        return 0;
    }
    
    private function calculateSiteSize() {
        return $this->calculateDirectorySize($this->wordpress_path);
    }
    
    private function calculateDirectorySize($directory) {
        $size = 0;
        if (is_dir($directory)) {
            try {
                $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS));
                foreach ($iterator as $file) {
                    if ($file->isFile()) {
                        $size += $file->getSize();
                    }
                }
            } catch (Exception $e) {
                // Dossier inaccessible
            }
        }
        return $size;
    }
    
    private function extractDatabaseConfig($wp_config_path) {
        $content = file_get_contents($wp_config_path);
        $config = array();
        
        $constants = array('DB_HOST', 'DB_NAME', 'DB_USER', 'DB_PASSWORD');
        
        foreach ($constants as $constant) {
            if (preg_match("/define\s*\(\s*['\"]" . $constant . "['\"]\s*,\s*['\"](.*?)['\"]\s*\)/", $content, $matches)) {
                $config[$constant] = $matches[1];
            }
        }
        
        return count($config) === 4 ? $config : false;
    }
    
    private function testDatabaseConnection($db_config) {
        try {
            $dsn = "mysql:host={$db_config['DB_HOST']};dbname={$db_config['DB_NAME']}";
            $pdo = new PDO($dsn, $db_config['DB_USER'], $db_config['DB_PASSWORD']);
            return true;
        } catch (PDOException $e) {
            return false;
        }
    }
    
    private function createDatabaseDump($db_config, $output_file) {
        // Tentative avec mysqldump
        $mysqldump_cmd = sprintf(
            "mysqldump -h '%s' -u '%s' -p'%s' '%s' > '%s' 2>/dev/null",
            $db_config['DB_HOST'],
            $db_config['DB_USER'],
            $db_config['DB_PASSWORD'],
            $db_config['DB_NAME'],
            $output_file
        );
        
        exec($mysqldump_cmd, $output, $return_code);
        
        if ($return_code === 0 && file_exists($output_file) && filesize($output_file) > 1000) {
            return true;
        }
        
        // Fallback: dump PHP/PDO
        return $this->createDatabaseDumpPHP($db_config, $output_file);
    }
    
    private function createDatabaseDumpPHP($db_config, $output_file) {
        try {
            $dsn = "mysql:host={$db_config['DB_HOST']};dbname={$db_config['DB_NAME']}";
            $pdo = new PDO($dsn, $db_config['DB_USER'], $db_config['DB_PASSWORD']);
            
            $sql_content = "-- WordPress Database Backup\n";
            $sql_content .= "-- Generated by WordPress Backup Expert\n";
            $sql_content .= "-- Date: " . date('Y-m-d H:i:s') . "\n\n";
            
            // R√©cup√©ration des tables
            $tables = $pdo->query("SHOW TABLES")->fetchAll(PDO::FETCH_COLUMN);
            
            foreach ($tables as $table) {
                // Structure de la table
                $create_table = $pdo->query("SHOW CREATE TABLE `$table`")->fetch(PDO::FETCH_ASSOC);
                $sql_content .= "\n-- Structure for table `$table`\n";
                $sql_content .= "DROP TABLE IF EXISTS `$table`;\n";
                $sql_content .= $create_table['Create Table'] . ";\n\n";
                
                // Donn√©es de la table
                $rows = $pdo->query("SELECT * FROM `$table`");
                if ($rows->rowCount() > 0) {
                    $sql_content .= "-- Data for table `$table`\n";
                    
                    while ($row = $rows->fetch(PDO::FETCH_ASSOC)) {
                        $values = array();
                        foreach ($row as $value) {
                            if ($value === null) {
                                $values[] = 'NULL';
                            } else {
                                $values[] = "'" . addslashes($value) . "'";
                            }
                        }
                        $sql_content .= "INSERT INTO `$table` VALUES(" . implode(',', $values) . ");\n";
                    }
                    $sql_content .= "\n";
                }
            }
            
            return file_put_contents($output_file, $sql_content) !== false;
            
        } catch (PDOException $e) {
            return false;
        }
    }
    
    private function scanFilesForBackup() {
        $files = array();
        
        try {
            $iterator = new RecursiveIteratorIterator(
                new RecursiveDirectoryIterator($this->wordpress_path, RecursiveDirectoryIterator::SKIP_DOTS),
                RecursiveIteratorIterator::SELF_FIRST
            );
            
            foreach ($iterator as $file) {
                if ($file->isFile()) {
                    $file_path = $file->getPathname();
                    $relative_path = str_replace($this->wordpress_path, '', $file_path);
                    
                    // V√©rification exclusions
                    if ($this->shouldExcludeFile($relative_path)) {
                        $this->backup_stats['files_skipped']++;
                        continue;
                    }
                    
                    // V√©rification taille
                    if ($file->getSize() > $this->backup_config['max_file_size']) {
                        $this->backup_stats['files_skipped']++;
                        continue;
                    }
                    
                    $files[] = $file_path;
                    $this->backup_stats['total_size'] += $file->getSize();
                }
            }
            
        } catch (Exception $e) {
            // Erreur de scan
        }
        
        return $files;
    }
    
    private function shouldExcludeFile($relative_path) {
        // Exclusion dossiers uploads si demand√©
        if ($this->exclude_uploads && strpos($relative_path, 'wp-content/uploads/') === 0) {
            return true;
        }
        
        // Exclusion dossiers configur√©s
        foreach ($this->backup_config['excluded_dirs'] as $excluded_dir) {
            if (strpos($relative_path, $excluded_dir) === 0) {
                return true;
            }
        }
        
        // Exclusion fichiers sp√©cifiques
        $filename = basename($relative_path);
        if (in_array($filename, $this->backup_config['excluded_files'])) {
            return true;
        }
        
        // Exclusion patterns
        $excluded_patterns = array(
            '/\.bak$/',
            '/\.tmp$/',
            '/\.temp$/',
            '/\.log$/',
            '/\.cache$/'
        );
        
        foreach ($excluded_patterns as $pattern) {
            if (preg_match($pattern, $filename)) {
                return true;
            }
        }
        
        return false;
    }
    
    private function copyFileSecurely($source, $destination) {
        try {
            // V√©rification source
            if (!file_exists($source) || !is_readable($source)) {
                return false;
            }
            
            // Copie avec pr√©servation des m√©tadonn√©es
            if (copy($source, $destination)) {
                // Pr√©servation des permissions et timestamps
                chmod($destination, fileperms($source));
                touch($destination, filemtime($source));
                return true;
            }
            
        } catch (Exception $e) {
            // Erreur de copie
        }
        
        return false;
    }
    
    private function compressFile($file_path) {
        if (!$this->compress_backup) {
            return false;
        }
        
        $compressed_file = $file_path . '.gz';
        
        try {
            $source = fopen($file_path, 'rb');
            $dest = gzopen($compressed_file, 'wb9');
            
            if ($source && $dest) {
                while (!feof($source)) {
                    gzwrite($dest, fread($source, 8192));
                }
                
                fclose($source);
                gzclose($dest);
                
                return file_exists($compressed_file) ? $compressed_file : false;
            }
            
        } catch (Exception $e) {
            // Erreur compression
        }
        
        return false;
    }
    
    private function createBackupReadme() {
        $readme_content = "# Sauvegarde WordPress Expert\n\n";
        $readme_content .= "## Informations g√©n√©rales\n";
        $readme_content .= "- **Date de cr√©ation :** " . date('Y-m-d H:i:s') . "\n";
        $readme_content .= "- **Site WordPress :** {$this->wordpress_path}\n";
        $readme_content .= "- **Version WordPress :** " . $this->getWordPressVersion() . "\n";
        $readme_content .= "- **Script version :** 3.0\n";
        $readme_content .= "- **Cr√©√© par :** WordPress Backup Expert - TeddyWP.com\n\n";
        
        $readme_content .= "## Contenu de la sauvegarde\n";
        $readme_content .= "- `database/` : Dump complet de la base de donn√©es\n";
        $readme_content .= "- `files/` : Tous les fichiers WordPress\n";
        $readme_content .= "- `config/` : Fichiers de configuration (wp-config.php, .htaccess)\n";
        $readme_content .= "- `backup-manifest.json` : M√©tadonn√©es de la sauvegarde\n\n";
        
        $readme_content .= "## Instructions de restauration\n";
        $readme_content .= "1. D√©compressez l'archive si n√©cessaire\n";
        $readme_content .= "2. Copiez le contenu du dossier `files/` vers votre nouveau WordPress\n";
        $readme_content .= "3. Importez `database/database.sql` dans votre base MySQL\n";
        $readme_content .= "4. Adaptez `config/wp-config.php` avec vos nouveaux param√®tres DB\n";
        $readme_content .= "5. Copiez `config/.htaccess` si n√©cessaire\n";
        $readme_content .= "6. V√©rifiez les permissions des fichiers\n\n";
        
        $readme_content .= "## Support\n";
        $readme_content .= "Pour toute assistance : https://teddywp.com/depannage-wordpress/\n";
        
        file_put_contents($this->backup_directory . 'README.md', $readme_content);
    }
    
    private function removeDirectory($dir) {
        if (is_dir($dir)) {
            $files = array_diff(scandir($dir), array('.', '..'));
            foreach ($files as $file) {
                (is_dir("$dir/$file")) ? $this->removeDirectory("$dir/$file") : unlink("$dir/$file");
            }
            rmdir($dir);
        }
    }
    
    private function formatBytes($size, $precision = 2) {
        if ($size == 0) return '0 B';
        
        $units = array('B', 'KB', 'MB', 'GB', 'TB');
        $base = log($size, 1024);
        
        return round(pow(1024, $base - floor($base)), $precision) . ' ' . $units[floor($base)];
    }
}

// =====================================================
// LANCEMENT DU SCRIPT
// =====================================================

// Parse des arguments
$wordpress_path = './';
$options = array();

for ($i = 1; $i < $argc; $i++) {
    $arg = $argv[$i];
    
    if ($arg === '--compress') {
        $options['compress'] = true;
    } elseif ($arg === '--exclude-uploads') {
        $options['exclude_uploads'] = true;
    } elseif ($arg === '--test-restore') {
        $options['test_restore'] = true;
    } elseif (!isset($wordpress_path_set)) {
        $wordpress_path = rtrim($arg, '/') . '/';
        $wordpress_path_set = true;
        
        if (!is_dir($wordpress_path)) {
            echo "‚ùå Erreur: Le chemin '$wordpress_path' n'existe pas.\n";
            echo "Usage: php backup-wordpress.php [chemin-wordpress] [--compress] [--exclude-uploads] [--test-restore]\n";
            exit(1);
        }
    }
}

// Affichage de l'aide
if (isset($argv[1]) && in_array($argv[1], array('--help', '-h'))) {
    echo "üìñ AIDE - SAUVEGARDE WORDPRESS COMPL√àTE\n";
    echo "=======================================\n\n";
    echo "Usage: php backup-wordpress.php [chemin-wordpress] [options]\n\n";
    echo "Options:\n";
    echo "  --compress         Compresser la sauvegarde (gzip)\n";
    echo "  --exclude-uploads  Exclure le dossier uploads\n";
    echo "  --test-restore     Tester la restauration apr√®s sauvegarde\n";
    echo "  --help, -h         Afficher cette aide\n\n";
    echo "Exemples:\n";
    echo "  php backup-wordpress.php\n";
    echo "  php backup-wordpress.php /var/www/monsite\n";
    echo "  php backup-wordpress.php /var/www/monsite --compress --test-restore\n\n";
    exit(0);
}

// Confirmation avant sauvegarde
echo "‚ö†Ô∏è  ATTENTION: Ce script va cr√©er une sauvegarde compl√®te de WordPress\n";
echo "üíæ La sauvegarde peut prendre du temps selon la taille du site\n";
echo "üîç Assurez-vous d'avoir suffisamment d'espace disque disponible\n\n";
echo "Continuer la sauvegarde ? [y/N]: ";

$handle = fopen("php://stdin", "r");
$confirm = trim(fgets($handle));

if (strtolower($confirm) !== 'y') {
    echo "‚ùå Sauvegarde annul√©e\n";
    exit(0);
}
echo "\n";

// Lancement de la sauvegarde
try {
    $backup_manager = new WordPressBackupManager($wordpress_path, $options);
    $backup_manager->runCompleteBackup();
} catch (Exception $e) {
    echo "‚ùå Erreur fatale: " . $e->getMessage() . "\n";
    echo "üìû Support expert: https://teddywp.com/depannage-wordpress/\n";
    exit(1);
}

echo "\nüèÅ Sauvegarde WordPress termin√©e avec succ√®s !\n";
echo "üí° V√©rifiez le contenu de la sauvegarde avant de compter dessus\n";
echo "üìû Besoin de solution sauvegarde automatis√©e ? Expert WordPress disponible 24/7\n";
?>
